---
import AvatarMenu from "@/components/AvatarMenu"

import { getProfile } from "@/lib/services/profileService"
import { getEventRegistration } from "@/lib/services/registrationService"
import { createUserClient } from "@/lib/supabase"

let userInitials = ""

const supabase = await createUserClient(Astro.cookies)
const profile = await getProfile(supabase)

const names = profile?.first_name.split(" ")
if (names?.length > 1) {
  userInitials = (names[0][0] + names[1][0]).toUpperCase()
} else {
  userInitials = profile?.first_name[0].toUpperCase()
}

const { eventSlug } = Astro.props
const registration = await getEventRegistration(supabase, profile?.id, eventSlug)
---

<AvatarMenu
  avatarUrl={profile?.avatar_url}
  userName={profile?.first_name}
  userInitials={userInitials}
  email={profile?.email}
  admin={profile?.is_admin}
  registered={!!registration}
  eventSlug={eventSlug}
  client:load
/>
