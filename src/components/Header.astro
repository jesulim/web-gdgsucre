---
import { Image } from "astro:assets"
import UserSignIn from "@/assets/icons/social/user-round-plus.svg"
import CredentialIcon from "@/assets/logos/credential.svg"
import LogoBlackIO from "@/assets/logos/IO_Extended_Black.png"

import LogoutIcon from "@/assets/logos/logout.svg"
import Avatar from "@/components/Avatar.astro"

const refreshToken = Astro.cookies.has("sb-refresh-token")

const navLinks = [
  { name: "Paquetes", href: "/#seccion-paquetes" },
  { name: "Sobre el evento", href: "/#about" },
  { name: "Speakers", href: "/#speakers" },
  { name: "Sponsors", href: "/#sponsors" },
  { name: "Agenda", href: "/#agenda" },
  { name: "Equipo", href: "/#organizadores" },
]
---

<nav class="w-full h-20 bg-white flex items-center justify-between px-6 border-b shadow-sm fixed top-0 left-0 z-50">
  <!-- Logo -->
  <a href="/#" class="flex items-center">
    <Image src={LogoBlackIO} alt="GDG Logo" width={140} height={40} class="object-contain md:w-[200px] md:h-[46px]" />
  </a>

  <!-- Navegación desktop -->
  <ul class="hidden md:flex gap-[49px] h-[32px]">
    {navLinks.map(link => (
      <li>
        <a href={link.href} class="text-gray-800 text-base font-medium leading-6 pb-1 border-b-2 border-transparent hover:border-blue-500 hover:text-blue-500 transition-colors duration-200">
          {link.name}
        </a>
      </li>
    ))}
  </ul>

  <!-- Botones / sesión -->
  <div class="flex items-center gap-4 h-[42px]">
    <!-- Eventos Pasados (visible en desktop y móvil) -->
    <a href="https://devfest2024.gdgsucre.com/pastEvents/" class="hidden md:inline text-blue-500 border-2 border-blue-500 bg-white hover:bg-blue-500 hover:text-white font-medium text-sm lg:text-base leading-5 lg:leading-6 px-4 lg:px-6 py-[6px] lg:py-[9px] rounded-full transition-colors duration-200">
      Eventos Pasados
    </a>

    <!-- Avatar o Login -->
    {refreshToken ? (
      <div class="relative">
        <div class="w-10 h-10 lg:w-12 lg:h-12 rounded-full bg-gray-200">
          <Avatar eventSlug="io-extended-25" />
        </div>

        <!-- Dropdown personalizado -->
        <div id="user-menu" class="absolute right-0 mt-2 w-[176px] h-[93px] bg-white rounded-[8px] shadow-lg px-4 py-[10px] z-50 border border-gray-200 opacity-0 transition-opacity duration-300 flex flex-col gap-4 text-nowrap">
          <a
            href="/registro/io-extended-25"
            class="flex items-center w-[144px] h-[24px] gap-2 px-1 text-black text-base font-medium leading-6 hover:text-blue-500 transition-colors duration-200"
          >
            <CredentialIcon class="w-[21px] h-[17px] fill-current text-black" />
            <span class="text-[16px] font-medium leading-6">Ver Credencial</span>
          </a>
          <a
            href="/api/auth/signout"
            class="flex items-center w-[144px] h-[24px] gap-2 px-1 text-black text-base font-medium leading-6 hover:text-blue-500 transition-colors duration-200"
          >
            <LogoutIcon class="w-[21px] h-[17px] fill-current text-black" />
            <span class="text-[16px] font-medium leading-6">Cerrar Sesión</span>
          </a>
        </div>
      </div>
    ) : (
      <a href="/api/auth/signin" class="hidden md:inline bg-blue-500 text-white hover:bg-[#3367D6] font-medium text-sm lg:text-base leading-5 lg:leading-6 px-5 lg:px-8 py-[6px] lg:py-[9px] rounded-full transition-colors duration-200">
        Iniciar Sesión
      </a>

      <a
        href="/api/auth/signin"
        class="md:hidden flex items-center justify-center w-12 h-12 rounded-full border border-gray-300 hover:border-blue-500 transition"
        aria-label="Iniciar sesión"
      >
        <UserSignIn class="w-8 h-8 text-gray-800" />
      </a>
    )}

    <!-- Hamburguesa móvil -->
    <button id="menu-toggle" class="md:hidden p-2 border rounded" aria-label="Abrir menú">
      <svg class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    </button>
  </div>

  <!-- Menú hamburguesa móvil -->
  <div id="mobile-menu" class="absolute top-full left-0 w-full bg-white shadow-md py-4 px-6 flex-col gap-4 hidden md:hidden border-t border-gray-200">
    <ul class="flex flex-col gap-4">
      {navLinks.map(link => (
        <li>
          <a href={link.href} class="text-gray-800 text-lg font-medium hover:text-blue-500 transition-colors">
            {link.name}
          </a>
        </li>
      ))}
    </ul>
    <a href="https://devfest2024.gdgsucre.com/pastEvents/" class="mt-4 block text-blue-500 border-2 border-blue-500 bg-white hover:bg-blue-500 hover:text-white text-center font-medium text-base leading-6 px-6 py-[9px] rounded-full transition-colors duration-200">
      Eventos Pasados
    </a>
  </div>
</nav>

<!-- Script funcional -->
<script type="module" is:inline>
  const menuToggle = document.getElementById('menu-toggle');
  const mobileMenu = document.getElementById('mobile-menu');
  const avatarBtn = document.getElementById('avatar-btn');
  const userMenu = document.getElementById('user-menu');

  let isMenuOpen = false;
  let isUserMenuOpen = false;

  menuToggle?.addEventListener('click', () => {
    isMenuOpen = !isMenuOpen;
    mobileMenu.classList.toggle('hidden', !isMenuOpen);
  });

  avatarBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    isUserMenuOpen = !isUserMenuOpen;
    if (isUserMenuOpen) {
      userMenu.classList.remove('hidden');
      requestAnimationFrame(() => {
        userMenu.classList.add('opacity-100');
        userMenu.classList.remove('opacity-0');
      });
    } else {
      userMenu.classList.remove('opacity-100');
      userMenu.classList.add('opacity-0');
      setTimeout(() => userMenu.classList.add('hidden'), 300);
    }
    avatarBtn.setAttribute('aria-expanded', isUserMenuOpen);
  });

  document.addEventListener('click', (e) => {
    // Cerrar menú hamburguesa si está abierto y el click no es en toggle ni menú
    if (
      isMenuOpen &&
      !menuToggle.contains(e.target) &&
      !mobileMenu.contains(e.target)
    ) {
      isMenuOpen = false;
      mobileMenu.classList.add('hidden');
    }

    // Cerrar menú usuario si está abierto y el click no es en avatarBtn ni userMenu
    if (
      isUserMenuOpen &&
      !avatarBtn?.contains(e.target) &&
      !userMenu?.contains(e.target)
    ) {
      isUserMenuOpen = false;
      userMenu.classList.remove('opacity-100');
      userMenu.classList.add('opacity-0');
      setTimeout(() => userMenu.classList.add('hidden'), 300);
      avatarBtn?.setAttribute('aria-expanded', false);
    }
  });
</script>
