---
import Header from "@/components/Header.astro"
import ProfileCard from "@/components/io-extended-25/ProfileCard"
import BaseLayout from "@/layout/BaseLayout.astro"
import { getProfile } from "@/lib/services/profileService"
import { getEventRegistration } from "@/lib/services/registrationService"
import { createUserClient } from "@/lib/supabase"
const supabase = await createUserClient(Astro.cookies)
const profile = await getProfile(supabase)
if (!profile) return Astro.redirect("/")

const registration = await getEventRegistration(supabase, profile?.id, Astro.params.eventSlug || "")

const {
  data: { user },
} = await supabase.auth.getUser()

const avatarUrl = user?.user_metadata?.avatar_url || null
const userName = user?.user_metadata?.full_name || user?.email || "Usuario"
const userInitial = userName.charAt(0).toUpperCase()

if (!registration || registration?.status !== "confirmed") return Astro.redirect("/")
---

<BaseLayout>
    <Header />
    <main class="mt-16 pt-12 flex">
        <div class="mx-auto px-4">
            <ProfileCard
                client:load
                name={userName}
                title={`${profile?.id || "Participante"}`}
                handle={`${profile?.email}`}
                status=""
                contactText="Contact"
                miniAvatarUrl={avatarUrl}
                avatarUrl={avatarUrl}
                showUserInfo={true}
                enableTilt={true}
                enableMobileTilt={false}
                iconUrl="/favicon.svg"
                grainUrl="/favicon.svg"
                onContactClick={() => console.log("Contact clicked")}
            />
            <!-- </div> -->
        </div>
    </main>
</BaseLayout>
